## 结论（你要的是什么）
- 目前的 GraphState.applyPatch 每次都会重建整图索引，这是“触及整个图结构”。
- 要实现“所有更新只计算变动部分”，需要把事实层与索引层都改为：**可变存储 + 增量 apply + Undo 回滚**，并把校验改为 **默认增量校验**（只看 patch 相关部分）。
- 不做兼容：会直接替换/删除旧入口与旧实现，所有新命名严格遵守 AGENTS（≤2 单词、禁止 handle/process/do 等）。

## 1) 新事实层：GraphStore（增量）
- 新建 `GraphStore`（或重命名现有 GraphState 文件/导出为 GraphStore）：
  - 内部使用可变 `Map` + 可变邻接 `string[]`；不再在 apply 时 `new GraphState(...)` 全量重建。
  - 提供只读查询 API（getNode/getEdge/getIncomingEdges…）保持语义清晰。
  - 新增核心方法：
    - `apply(patch: Patch): UndoPatch`：**只更新受影响键**，并返回可回滚的 UndoPatch。
    - `export(): Graph`：导出不可变快照。
- apply 的增量更新范围（O(Δ)）：
  - nodeAdd/nodeRemove/nodeReplace：只更新对应 node + endpoint 索引（input/output/endpoint/owner/nodeEndpoints）。
  - edgeAdd/edgeRemove/edgeReplace：只更新对应 edge + 4 处邻接表（source node、target node、source output、target input）。
- 严格约束（显式失败模式）：
  - patch 内同一 id 不允许同时 add/remove/replace；发现冲突直接抛错。
  - nodeRemove 必须先移除 incident edges（否则抛错）；nodeReplace 删除端点但仍有边引用时抛错。

## 2) 新事务层：GraphWorkspace 只做局部 Undo
- GraphWorkspace.update 改为：
  - 顺序 apply 每个 editor 操作产出的 patch
  - 逐步收集 `UndoPatch` 栈（后进先出）
  - 校验失败：按栈逆序 apply UndoPatch 回滚
- 删除/替换全量快照回滚（createSnapshot/restoreSnapshot、index snapshot）。

## 3) 索引层：IncrementalLookup 增量 + Undo
- IncrementalLookup 保持增量 apply，但回滚不再用 snapshot：
  - 新增 `apply(patch: Patch): void`
  - 新增 `revert(undo: UndoPatch): void` 或直接复用 `apply(undo)`
- 通过 UndoPatch 中携带的“被删除/被替换的旧对象”，实现纯局部回滚。

## 4) 校验层：默认增量 Validate
- 重构 validate 规则执行：
  - `validate(store, patch, options)` 只校验：
    - edgeAdd/edgeReplace
    - nodeReplace 影响到的 incident edges
    - edgeAdd/edgeRemove/edgeReplace 影响到的 input cardinality
    - nodeAdd/nodeReplace 的 endpoint/ID 冲突
  - 提供 `validateAll(store, options)` 仅用于导入/调试/显式全量校验。

## 5) API/命名与导出（严格 AGENTS）
- 类型命名收敛到 ≤2 单词：
  - `Patch`、`UndoPatch`、`GraphStore`、`ImpactSemantics` 等。
- 文件/目录导入全部走各目录 `index.ts`（如 `../model`、`../state`、`../subgraph`）。
- 所有 export 的公共 API 与关键算法入口补齐 JSDoc（意图/约束/边界/失败模式/example）。

## 6) 测试与示例
- 新增/更新 tests：
  - 断言 update 后仅相关邻接键变化（白盒：debug stats/计数器或访问内部受控只读统计）。
  - 断言校验失败后回滚不改变 store/index。
  - 断言 validate(patch) 覆盖 nodeReplace/edgeReplace/edgeRemove。
- 更新 examples：增加一个“多次 update 不全量重建”的示例（输出 debug stats），并保证可运行。

## 7) 验证
- `pnpm -w exec tsc -p packages/graph/tsconfig.json --noEmit`
- `pnpm -w dlx tsx packages/graph/tests/*.test.ts`

如果你确认这个方案，我会开始动手：先落 GraphStore+UndoPatch（最关键），再改 Workspace/Lookup，最后把 validate 改成默认增量并补齐测试与示例。